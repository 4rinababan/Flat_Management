@page "/access-control/handle-locks"
@using System.Text.Json
@inject DeviceService DeviceService
@inject IJSRuntime JS
@inject ToastService ToastService

<h3 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Access Control</h3>

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 border-b pb-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Handle Lock Management</h2>
            <p class="text-gray-500 mt-1">Manage Lock Property, Maintenance and Status.</p>
        </div>
        <div class="flex items-center space-x-3 mt-4 md:mt-0 w-full md:w-auto">
            <div class="relative w-full md:w-64">
                <input value="@searchTerm" oninput="OnSearchChanged"
       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
       placeholder="Search Name, Code or Building..." />
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>
    </div>



@if (devices == null)
{
    <div class="flex justify-center py-10">
        <div class="animate-spin h-8 w-8 border-4 border-blue-400 border-t-transparent rounded-full"></div>
    </div>
}
else if (!filteredDevices.Any())
{
    <p class="text-gray-500">No devices found.</p>
}
else
{
    <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-5">
        @foreach (var device in pagedDevices)
        {
            var cardBg = device.ElectricQuantity < 20
                ? "bg-gray-700 dark:bg-gray-900"
                : "bg-gradient-to-b from-red-700 to-black dark:from-red-900 dark:to-gray-900";

            <div class="@cardBg border rounded-2xl shadow-lg hover:shadow-2xl hover:scale-[1.03] transition-all duration-200 ease-out p-4 relative flex flex-col items-center text-center text-white">

                <!-- Setting Icon -->
                <button class="absolute top-2 right-2 hover:text-yellow-400 transition-transform hover:rotate-90 duration-300"
                        @onclick="() => OpenSettingsModal(device)">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>

                <img src="assets/images/smart-lock.png" alt="Smart Lock" class="w-14 h-14 mb-3 opacity-90"/>

                <h4 class="text-sm font-semibold truncate w-full">@device.LockAlias</h4>
                <p class="text-xs opacity-80 mb-2">ID: @device.LockId</p>

                <div class="flex items-center gap-1 text-xs mb-3">
                    üîã <span>@device.ElectricQuantity%</span>
                    <span class="text-gray-400">|</span>
                    
                    üóùÔ∏è 
                    <span class="flex items-center gap-1">
                        <span>@device.NoKeyPwd</span>
                        <button class="text-gray-500 hover:text-gray-700" @onclick="() => CopyToClipboard(device.NoKeyPwd)" title="Copy">
                            üìã
                        </button>
                    </span>
                </div>

                <!-- Cards & Fingerprint -->
                <div class="flex justify-center gap-3 text-sm font-medium mb-3">
                    <div class="flex items-center gap-1 bg-white/30 rounded-xl px-2 py-1 shadow-sm">
                        ü™™ <span>@(cards?.Count(c => c.LockId == device.LockId) ?? 0)</span>
                    </div>
                    <div class="flex items-center gap-1 bg-white/30 rounded-xl px-2 py-1 shadow-sm">
                        ‚òùÔ∏è <span>@(fingerprints?.Count(f => f.LockId == device.LockId) ?? 0)</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2 w-full mb-2">
                    <button class="flex items-center justify-center gap-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-xl text-sm font-semibold shadow transition"
                            @onclick="() => UnlockDevice(device.LockId)">
                        üîì <span>Unlock</span>
                    </button>

                    <button class="flex items-center justify-center gap-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-xl text-sm font-semibold shadow transition"
                            @onclick="() => LockDevice(device.LockId)">
                        üîí <span>Lock</span>
                    </button>

                    <button class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-xl text-sm font-semibold shadow transition col-span-2"
                            @onclick="() => OpenAddCardModal(device.LockId)">
                        <i class="fa-solid fa-plus text-xs"></i>
                        <span>Add Card</span>
                    </button>

                    <button class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-xl text-sm font-semibold shadow transition col-span-2"
                            @onclick="() => OpenRecordsModal(device.LockId)">
                        üìú <span>Records</span>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-6 gap-3">
        <button class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition 
                    disabled:opacity-50 disabled:bg-gray-400" 
                @onclick="PrevPage" disabled="@(_currentPage == 1)">
            Prev
        </button>

        <span class="px-3 py-2 text-gray-700">Page @_currentPage of @_totalPages</span>

        <button class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition 
                    disabled:opacity-50 disabled:bg-gray-400" 
                @onclick="NextPage" disabled="@(_currentPage == _totalPages)">
            Next
        </button>
    </div>

}

<!-- Add Card Modal -->
@if (showAddCardModal)
{
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-96 shadow-2xl animate-fadeIn">
            <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">Add New Card</h3>

            <input type="text" @bind="newCardName"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 mb-3 dark:bg-gray-700 dark:text-white"
                   placeholder="Card Name / Alias" />

            <input type="text" @bind="newCardNumber"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 mb-3 dark:bg-gray-700 dark:text-white"
                   placeholder="Card Number" />

            <input type="number" @bind="validDays"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 mb-4 dark:bg-gray-700 dark:text-white"
                   placeholder="Valid Days (default 30)" min="1" />

            <div class="flex justify-end gap-2">
                <button class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition"
                        @onclick="CloseAddCardModal">Cancel</button>

                <button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow transition"
                        @onclick="AddCard">Add Card</button>
            </div>
        </div>
    </div>
}

<!-- Records Modal -->
@if (showRecordsModal)
{
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-11/12 max-w-4xl shadow-2xl animate-fadeIn overflow-auto max-h-[80vh]">
            <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">Lock Records - ID: @selectedRecordLockId</h3>

            <table class="min-w-full table-auto border border-gray-300 dark:border-gray-700 text-sm text-left">
                <thead class="bg-gray-200 dark:bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 border">Type</th>
                        <th class="px-3 py-2 border">User</th>
                        <th class="px-3 py-2 border">Access Method</th>
                        <th class="px-3 py-2 border">Date</th>
                    </tr>
                </thead>
                <tbody>
                    @if (lockRecords == null || !lockRecords.Any())
                    {
                        <tr>
                            <td colspan="4" class="px-3 py-2 border text-center text-gray-500">No records found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var record in lockRecords)
                        {
                            <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                                <td class="px-3 py-2 border">@record.RecordType</td>
                                <td class="px-3 py-2 border">@record.Username</td>
                                <td class="px-3 py-2 border">@GetAccessTypeMeaning(record.RecordType)</td>
                                <td class="px-3 py-2 border">@record.LockDate?.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <div class="flex justify-end mt-4">
                <button class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-600 transition"
                        @onclick="CloseRecordsModal">Close</button>
            </div>
        </div>
    </div>
}

@if (_copied)
{
    <div class="absolute bg-gray-800 text-white px-2 py-1 rounded shadow-md text-xs"
         style="top:@_yPx; left:@_xPx;">
        Copied!
    </div>
}

<AccessControlSettingsModal @ref="settingsModal" OnUpdated="ReloadDevices" />

@code {

    private bool _copied = false;
    private string _xPx = "0px";
    private string _yPx = "0px";
    [Parameter] public EventCallback OnUpdated { get; set; }
    
    private List<DeviceDto>? devices;
    private List<DeviceDto> filteredDevices = new();
    private List<DeviceDto> pagedDevices = new();
    private List<ICCardDto> cards = new();
    private List<FingerprintDto> fingerprints = new();

    private int _currentPage = 1;
    private int _pageSize = 16;
    private int _totalPages = 1;
    private string _searchTerm  = "";

    // Add Card modal
    private bool showAddCardModal = false;
    private long selectedLockId;
    private string newCardName = "";
    private string newCardNumber = "";
    private int validDays = 30;

    // Records modal
    private bool showRecordsModal = false;
    private long selectedRecordLockId;
    private List<RecordDto> lockRecords = new();

    private AccessControlSettingsModal settingsModal;
    private DeviceDto? selectedDevice;

    protected override async Task OnInitializedAsync()
    {
        await DeviceService.AuthAsync();
        devices = await DeviceService.GetDevicesAsync();
        UpdatePagination();
        await LoadCardsAndFingerprints();
    }

    private async Task CopyToClipboard(int noKeyPwd)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", noKeyPwd.ToString());

        // Tampilkan toast
        _copied = true;
        StateHasChanged();

        // Hilangkan toast setelah 1.5 detik
        await Task.Delay(150);
        _copied = false;
        StateHasChanged();
    }

    private string searchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value;
            _currentPage = 1;
            UpdatePagination();
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        _currentPage = 1; // reset ke halaman 1
        UpdatePagination();
    }

    private async Task ReloadDevices()
    {
        devices = await DeviceService.GetDevicesAsync();
        UpdatePagination();
        await LoadCardsAndFingerprints();
    }

    private void UpdatePagination()
    {
        if (devices == null) return;

        // Filter berdasarkan search term
        filteredDevices = string.IsNullOrWhiteSpace(searchTerm)
            ? devices
            : devices.Where(d => d.LockAlias.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();

        _totalPages = (int)Math.Ceiling(filteredDevices.Count / (double)_pageSize);
        _currentPage = Math.Min(_currentPage, _totalPages);
        _currentPage = Math.Max(_currentPage, 1);

        pagedDevices = filteredDevices.Skip((_currentPage - 1) * _pageSize).Take(_pageSize).ToList();
    }

    private void NextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            UpdatePagination();
        }
    }

    private void PrevPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            UpdatePagination();
        }
    }

    private async Task LoadCardsAndFingerprints()
    {
        if (devices == null) return;

        try
        {
            var cardTasks = devices.Select(d => DeviceService.GetCardsAsync(d.LockId));
            var cardResults = await Task.WhenAll(cardTasks);
            cards = cardResults.SelectMany(c => c).ToList();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load cards: {ex.Message}");
        }

        try
        {
            var fingerprintTasks = devices.Select(d => DeviceService.GetFingerprintsAsync(d.LockId));
            var fingerprintResults = await Task.WhenAll(fingerprintTasks);
            fingerprints = fingerprintResults?.SelectMany(f => f).ToList() ?? new List<FingerprintDto>();
        }
        catch
        {
            ToastService.ShowWarning($"Some locks may not support fingerprints.");
            fingerprints = new List<FingerprintDto>();
        }

        StateHasChanged();
    }

    private async Task UnlockDevice(long lockId)
    {
        try
        {
            await DeviceService.UnlockDeviceAsync(lockId);
            ToastService.ShowSuccess("Device unlocked ‚úÖ");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to unlock: {ex.Message}");
        }
    }

    private async Task LockDevice(long lockId)
    {
        try
        {
            await DeviceService.LockDeviceAsync(lockId);
            ToastService.ShowSuccess("Device locked üîí");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to lock: {ex.Message}");
        }
    }

    private void OpenAddCardModal(long lockId)
    {
        selectedLockId = lockId;
        showAddCardModal = true;
    }

    private void CloseAddCardModal()
    {
        showAddCardModal = false;
        newCardName = "";
        newCardNumber = "";
        validDays = 30;
    }

    private async Task AddCard()
    {
        try
        {
            await DeviceService.AddCardAsync(selectedLockId, newCardName, newCardNumber, validDays);
            ToastService.ShowSuccess("Card added successfully ‚úÖ");
            CloseAddCardModal();
            await LoadCardsAndFingerprints();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to add card: {ex.Message}");
        }
    }

    private void OpenSettingsModal(DeviceDto device)
    {
        selectedDevice = device;
        if (settingsModal != null)
        {
            settingsModal.OpenModal(device);
        }
        else
        {
            ToastService.ShowWarning("Settings modal not ready yet.");
        }
    }


    private async Task OpenRecordsModal(long lockId)
    {
        selectedRecordLockId = lockId;
        showRecordsModal = true;

        try
        {
            lockRecords = await DeviceService.GetRecordsAsync(lockId);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load records: {ex.Message}");
            lockRecords = new List<RecordDto>();
        }

        StateHasChanged();
    }

    private void CloseRecordsModal()
    {
        showRecordsModal = false;
        lockRecords.Clear();
    }

    private string GetAccessTypeMeaning(string recordType)
    {
        return recordType switch
        {
            "7" => "Kartu / RFID",
            "11" => "Password",
            "12" => "App / Username login",
            "47" => "Fingerprint",
            _ => "Unknown"
        };
    }
}

@page "/role-permission/{RoleId:int}"
@using Microsoft.AspNetCore.Identity
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@using MyApp.Core.ViewModels
@inject IMenuPermissionService MenuPermissionService
@inject IIdentityRoleService RoleService
@inject NavigationManager NavigationManager
@inject ToastService ToastService

<PageTitle>Role Permissions</PageTitle>

<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 border-b pb-4">
        <div class="flex items-center gap-4">
            <button @onclick="NavigateBack" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <div>
                <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">
                    Permissions for @Role?.Name
                </h2>
                <p class="text-gray-500 mt-1">Manage menu access and permissions</p>
            </div>
        </div>
        <button @onclick="SavePermissions"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg transition">
            Save Changes
        </button>
    </div>

    @if (Loading)
    {
        <div class="text-center py-10">
            <i class="fas fa-spinner fa-spin fa-2x text-blue-600"></i>
            <p class="mt-2 text-gray-600">Loading permissions...</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-b from-blue-700 to-black">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase">Menu</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white uppercase w-24">View</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white uppercase w-24">Create</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white uppercase w-24">Update</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white uppercase w-24">Delete</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var permission in Permissions.Where(m => !m.ParentId.HasValue))
                    {
                        <tr class="bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="@GetIconClass(permission.IconName) mr-2"></i>
                                    <span class="font-medium">@permission.MenuName</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <input type="checkbox" @bind="permission.CanView"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                            </td>
                            <td class="px-6 py-4 text-center">
                                <input type="checkbox" @bind="permission.CanCreate"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                            </td>
                            <td class="px-6 py-4 text-center">
                                <input type="checkbox" @bind="permission.CanUpdate"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                            </td>
                            <td class="px-6 py-4 text-center">
                                <input type="checkbox" @bind="permission.CanDelete"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                            </td>
                        </tr>
                        
                        @foreach (var subMenu in Permissions.Where(m => m.ParentId == permission.MenuId))
                        {
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="flex items-center ml-6">
                                        <i class="@GetIconClass(subMenu.IconName) mr-2"></i>
                                        <span>@subMenu.MenuName</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <input type="checkbox" @bind="subMenu.CanView"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <input type="checkbox" @bind="subMenu.CanCreate"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <input type="checkbox" @bind="subMenu.CanUpdate"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <input type="checkbox" @bind="subMenu.CanDelete"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter]
    public int RoleId { get; set; }

    private IdentityRole<int>? Role;
    private List<MenuPermissionViewModel> Permissions = new();
    private bool Loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            Loading = true;
            Role = await RoleService.GetRoleByIdAsync(RoleId.ToString());  // Convert to string
            if (Role == null)
            {
                NavigateBack();
                return;
            }

            var permissions = await MenuPermissionService.GetRolePermissionsAsync(RoleId);
            Permissions = permissions.MenuPermissions;
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error loading permissions: {ex.Message}");
        }
        finally
        {
            Loading = false;
        }
    }

    private async Task SavePermissions()
    {
        try
        {
            await MenuPermissionService.UpdateRolePermissionsAsync(
                Role.Name,
                Permissions
            );
            await ToastService.ShowSuccess("Permissions updated successfully");
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error saving permissions: {ex.Message}");
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/role-permission");
    }

    private string GetIconClass(string iconName)
    {
        return $"fas fa-{iconName} text-gray-500";
    }
}